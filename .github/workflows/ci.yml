name: UI test execution

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master
      - issue-*
      - fb_*
  push:
    branches:
      - master
      - issue-*
      - fb_*
  schedule:
    - cron: '* * * * *'

jobs:
  build_and_test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: maven

      - name: Install Browsers
        uses: browser-actions/setup-chrome@latest
      - uses: browser-actions/setup-firefox@latest
      - uses: browser-actions/setup-edge@latest

      - name: Build Project
        run: mvn clean install -DskipTests

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: target
          path: |
            ${{ github.workspace }}/target
            ${{ github.workspace }}/reports

  smoke_test:
    name: Smoke Tests
    needs: build_and_test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [ chrome, firefox, msedge ]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: maven

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run Smoke Tests
        run: mvn clean test -Drunmode=headless -Dbrowser=${{ matrix.browser }} -Dgroups=SWAG_LABS_SMOKE -Dtestng.parallel=methods -DthreadPoolSize=3 -Ddataproviderthreadcount=3

      - name: Generate Test Summary
        uses: test-summary/action@v2
        id: summary
        with:
          paths: "target/surefire-reports/TEST-*.xml" # Path to the test report files
        if: always()

      - name: Send Smoke Test Results to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          passed_count="${{ steps.summary.outputs.passed }}"
          failed_count="${{ steps.summary.outputs.failed }}"
          skipped_count="${{ steps.summary.outputs.skipped }}"
          total_count="${{ steps.summary.outputs.total }}"
          pass_percentage=$(awk "BEGIN {print ($passed_count/$total_count)*100}")
          fail_percentage=$(awk "BEGIN {print ($failed_count/$total_count)*100}")
          
          content="🚀 **Smoke Test Summary for ${matrix.browser}** 🚀\n"
          content+="🎉 **Passed**: ${passed_count}\n❌ **Failed**: ${failed_count}\n⚠️ **Skipped**: ${skipped_count}\n📊 **Total**: ${total_count}\n"
          content+="✅ **Pass %**: ${pass_percentage}% ❌ **Fail %**: ${fail_percentage}%\n"
          
          curl --location "$DISCORD_WEBHOOK_URL" \
               --header 'Content-Type: application/json' \
               --data-raw "{\"content\": \"$content\", \"username\": \"TestBot\"}"

  regression_test:
    name: Regression Tests
    needs: build_and_test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [ chrome, firefox, msedge ]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: maven

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run Regression Tests
        run: mvn clean test -Drunmode=headless -Dbrowser=${{ matrix.browser }} -Dgroups=SWAG_LABS_REGRESSION -Dtestng.parallel=methods -DthreadPoolSize=3 -Ddataproviderthreadcount=3

      - name: Generate Test Summary
        uses: test-summary/action@v2
        id: summary
        with:
          paths: "target/surefire-reports/TEST-*.xml" # Path to the test report files
        if: always()

      - name: Send Regression Test Results to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          passed_count="${{ steps.summary.outputs.passed }}"
          failed_count="${{ steps.summary.outputs.failed }}"
          skipped_count="${{ steps.summary.outputs.skipped }}"
          total_count="${{ steps.summary.outputs.total }}"
          pass_percentage=$(awk "BEGIN {print ($passed_count/$total_count)*100}")
          fail_percentage=$(awk "BEGIN {print ($failed_count/$total_count)*100}")

          content="🚀 **Smoke Test Summary for ${matrix.browser}** 🚀\n"
          content+="🎉 **Passed**: ${passed_count}\n❌ **Failed**: ${failed_count}\n⚠️ **Skipped**: ${skipped_count}\n📊 **Total**: ${total_count}\n"
          content+="✅ **Pass %**: ${pass_percentage}% ❌ **Fail %**: ${fail_percentage}%\n"

          curl --location "$DISCORD_WEBHOOK_URL" \
               --header 'Content-Type: application/json' \
               --data-raw "{\"content\": \"$content\", \"username\": \"TestBot\"}"

  e2e_test:
    name: E2E Tests
    needs:
    - build_and_test
    - smoke_test
    - regression_test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [ chrome, firefox, msedge ]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: maven

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run Regression Tests
        run: mvn clean test -Drunmode=headless -Dbrowser=${{ matrix.browser }} -Dgroups=SWAG_LABS_E2E -Dtestng.parallel=methods -DthreadPoolSize=3 -Ddataproviderthreadcount=3

      - name: Generate Test Summary
        uses: test-summary/action@v2
        id: summary
        with:
          paths: "target/surefire-reports/TEST-*.xml" # Path to the test report files
        if: always()

      - name: Send E2E Test Results to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          passed_count="${{ steps.summary.outputs.passed }}"
          failed_count="${{ steps.summary.outputs.failed }}"
          skipped_count="${{ steps.summary.outputs.skipped }}"
          total_count="${{ steps.summary.outputs.total }}"
          pass_percentage=$(awk "BEGIN {print ($passed_count/$total_count)*100}")
          fail_percentage=$(awk "BEGIN {print ($failed_count/$total_count)*100}")

          content="🚀 **Smoke Test Summary for ${matrix.browser}** 🚀\n"
          content+="🎉 **Passed**: ${passed_count}\n❌ **Failed**: ${failed_count}\n⚠️ **Skipped**: ${skipped_count}\n📊 **Total**: ${total_count}\n"
          content+="✅ **Pass %**: ${pass_percentage}% ❌ **Fail %**: ${fail_percentage}%\n"

          curl --location "$DISCORD_WEBHOOK_URL" \
               --header 'Content-Type: application/json' \
               --data-raw "{\"content\": \"$content\", \"username\": \"TestBot\"}"